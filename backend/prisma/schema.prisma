generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum AdminType {
  EVENT_ADMIN
  DEPARTMENT_ADMIN
}

enum EventType {
  CIRCUIT_ASSEMBLY
  REGIONAL_CONVENTION
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum DepartmentType {
  ACCOUNTS
  ATTENDANT
  AUDIO_VIDEO
  BAPTISM
  CLEANING
  FIRST_AID
  INFORMATION_VOLUNTEER_SERVICE
  INSTALLATION
  LOST_FOUND_CHECKROOM
  PARKING
  ROOMING
  TRUCKING_EQUIPMENT
}

enum Appointment {
  PUBLISHER
  MINISTERIAL_SERVANT
  ELDER
}

enum CheckInStatus {
  CHECKED_IN
  CHECKED_OUT
  MISSED
}

enum MessagePriority {
  NORMAL
  URGENT
}

enum RecipientType {
  INDIVIDUAL
  POST
  ROLE
  DEPARTMENT
  BROADCAST
}

// ============================================================================
// ADMIN
// ============================================================================

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  congregation String
  adminType    AdminType @default(DEPARTMENT_ADMIN) @map("admin_type")
  departmentId String?   @map("department_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  events       Event[]
  department   Department? @relation(fields: [departmentId], references: [id])
  sentMessages Message[]   @relation("AdminSentMessages")
  notes        EventNote[]

  @@map("admins")
}

// ============================================================================
// EVENT
// ============================================================================

model Event {
  id        String      @id @default(cuid())
  name      String
  type      EventType
  location  String
  startDate DateTime    @map("start_date")
  endDate   DateTime    @map("end_date")
  status    EventStatus @default(DRAFT)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  createdById String       @map("created_by_id")
  createdBy   Admin        @relation(fields: [createdById], references: [id])
  departments Department[]
  roles       Role[]
  sessions    Session[]
  volunteers  Volunteer[]
  posts       Post[]
  messages    Message[]
  quickAlerts QuickAlert[]
  notes       EventNote[]

  @@map("events")
}

// ============================================================================
// DEPARTMENT
// ============================================================================

model Department {
  id             String         @id @default(cuid())
  departmentType DepartmentType @map("department_type")
  customName     String?        @map("custom_name") // Optional override for display
  description    String?
  displayOrder   Int            @default(0) @map("display_order")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  eventId    String      @map("event_id")
  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  admins     Admin[]
  volunteers Volunteer[]
  posts      Post[]
  messages   Message[]   @relation("DepartmentMessages")

  @@unique([eventId, departmentType])
  @@map("departments")
}

// ============================================================================
// SESSION
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  name         String
  date         DateTime
  startTime    DateTime @map("start_time")
  endTime      DateTime @map("end_time")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  eventId             String                  @map("event_id")
  event               Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  scheduleAssignments ScheduleAssignment[]
  availability        VolunteerAvailability[]
  attendanceCounts    AttendanceCount[]

  @@map("sessions")
}

// ============================================================================
// VOLUNTEERS
// ============================================================================

model Volunteer {
  id           String      @id @default(cuid())
  firstName    String      @map("first_name")
  lastName     String      @map("last_name")
  phone        String?
  email        String?
  congregation String
  appointment  Appointment @default(PUBLISHER)
  generatedId  String      @unique @map("generated_id")
  loginToken   String      @map("login_token")
  notes        String?
  isActive     Boolean     @default(true) @map("is_active")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  eventId             String                  @map("event_id")
  event               Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  departmentId        String?                 @map("department_id")
  department          Department?             @relation(fields: [departmentId], references: [id])
  roleId              String?                 @map("role_id")
  role                Role?                   @relation(fields: [roleId], references: [id])
  scheduleAssignments ScheduleAssignment[]
  availability        VolunteerAvailability[]
  checkIns            CheckIn[]
  sentMessages        Message[]               @relation("VolunteerSentMessages")
  receivedMessages    Message[]               @relation("ReceivedDirectMessages")
  messageRecipients   MessageRecipient[]
  attendanceCounts    AttendanceCount[]

  @@map("volunteers")
}

model VolunteerAvailability {
  id          String   @id @default(cuid())
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  volunteerId String    @map("volunteer_id")
  volunteer   Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  sessionId   String    @map("session_id")
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([volunteerId, sessionId])
  @@map("volunteer_availability")
}

model Role {
  id           String   @id @default(cuid())
  name         String
  description  String?
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  eventId    String      @map("event_id")
  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  volunteers Volunteer[]
  messages   Message[]   @relation("RoleMessages")

  @@map("roles")
}

// ============================================================================
// POSTS & SCHEDULE ASSIGNMENTS
// ============================================================================

model Post {
  id           String   @id @default(cuid())
  name         String
  description  String?
  capacity     Int      @default(1)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  eventId             String               @map("event_id")
  event               Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  departmentId        String               @map("department_id")
  department          Department           @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  scheduleAssignments ScheduleAssignment[]
  messages            Message[]            @relation("PostMessages")
  attendanceCounts    AttendanceCount[]

  @@map("posts")
}

model ScheduleAssignment {
  id        String   @id @default(cuid())
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  volunteerId String    @map("volunteer_id")
  volunteer   Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  sessionId   String    @map("session_id")
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  postId      String    @map("post_id")
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  checkIn     CheckIn?

  @@unique([volunteerId, sessionId])
  @@map("schedule_assignments")
}

// ============================================================================
// CHECK-IN
// ============================================================================

model CheckIn {
  id           String        @id @default(cuid())
  checkInTime  DateTime?     @map("check_in_time")
  checkOutTime DateTime?     @map("check_out_time")
  status       CheckInStatus @default(CHECKED_IN)
  isLate       Boolean       @default(false) @map("is_late")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  scheduleAssignmentId String             @unique @map("schedule_assignment_id")
  scheduleAssignment   ScheduleAssignment @relation(fields: [scheduleAssignmentId], references: [id], onDelete: Cascade)
  volunteerId          String             @map("volunteer_id")
  volunteer            Volunteer          @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@map("check_ins")
}

// ============================================================================
// ATTENDANCE COUNTS (CO-24)
// ============================================================================

model AttendanceCount {
  id        String   @id @default(cuid())
  count     Int
  countTime DateTime @map("count_time")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessionId     String    @map("session_id")
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  postId        String?   @map("post_id")
  post          Post?     @relation(fields: [postId], references: [id])
  submittedById String    @map("submitted_by_id")
  submittedBy   Volunteer @relation(fields: [submittedById], references: [id])

  @@map("attendance_counts")
}

// ============================================================================
// MESSAGING
// ============================================================================

model Message {
  id            String          @id @default(cuid())
  content       String
  priority      MessagePriority @default(NORMAL)
  recipientType RecipientType
  isQuickAlert  Boolean         @default(false) @map("is_quick_alert")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Sender (admin or volunteer)
  senderAdminId     String?    @map("sender_admin_id")
  senderAdmin       Admin?     @relation("AdminSentMessages", fields: [senderAdminId], references: [id])
  senderVolunteerId String?    @map("sender_volunteer_id")
  senderVolunteer   Volunteer? @relation("VolunteerSentMessages", fields: [senderVolunteerId], references: [id])

  // Target (for non-broadcast messages)
  targetVolunteerId  String?     @map("target_volunteer_id")
  targetVolunteer    Volunteer?  @relation("ReceivedDirectMessages", fields: [targetVolunteerId], references: [id])
  targetPostId       String?     @map("target_post_id")
  targetPost         Post?       @relation("PostMessages", fields: [targetPostId], references: [id])
  targetRoleId       String?     @map("target_role_id")
  targetRole         Role?       @relation("RoleMessages", fields: [targetRoleId], references: [id])
  targetDepartmentId String?     @map("target_department_id")
  targetDepartment   Department? @relation("DepartmentMessages", fields: [targetDepartmentId], references: [id])

  // Recipients tracking
  recipients MessageRecipient[]

  @@map("messages")
}

model MessageRecipient {
  id        String    @id @default(cuid())
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  messageId   String    @map("message_id")
  message     Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  volunteerId String    @map("volunteer_id")
  volunteer   Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([messageId, volunteerId])
  @@map("message_recipients")
}

model QuickAlert {
  id           String          @id @default(cuid())
  name         String
  message      String
  priority     MessagePriority @default(NORMAL)
  isActive     Boolean         @default(true) @map("is_active")
  displayOrder Int             @default(0) @map("display_order")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("quick_alerts")
}

// ============================================================================
// EVENT NOTES
// ============================================================================

model EventNote {
  id        String       @id @default(cuid())
  title     String
  content   String
  category  NoteCategory @default(GENERAL)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // Relations
  eventId     String @map("event_id")
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdById String @map("created_by_id")
  createdBy   Admin  @relation(fields: [createdById], references: [id])

  @@map("event_notes")
}

enum NoteCategory {
  GENERAL
  IMPROVEMENT
  ISSUE
  STAFFING
  LOGISTICS
  COMMUNICATION
}
