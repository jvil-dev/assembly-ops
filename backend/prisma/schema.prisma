generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Admin {
  id               String            @id @default(cuid())
  email            String            @unique
  passwordHash     String
  firstName        String
  lastName         String
  phone            String?
  congregation     String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  attendanceCounts AttendanceCount[]
  checkIns         CheckIn[]
  events           EventAdmin[]
  messages         Message[]
  refreshTokens    RefreshToken[]

  @@index([email])
}

model AttendanceCount {
  id            String   @id @default(cuid())
  count         Int
  notes         String?
  sessionId     String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  submittedById String
  session       Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  submittedBy   Admin    @relation(fields: [submittedById], references: [id])

  @@index([sessionId])
}

model CheckIn {
  id            String             @id @default(cuid())
  checkInTime   DateTime           @default(now())
  checkOutTime  DateTime?
  assignmentId  String             @unique
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  checkedInById String?
  notes         String?
  status        CheckInStatus      @default(CHECKED_IN)
  assignment    ScheduleAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  checkedInBy   Admin?             @relation(fields: [checkedInById], references: [id])

  @@index([assignmentId])
}

model Department {
  id             String         @id @default(cuid())
  name           String
  departmentType DepartmentType
  description    String?
  eventId        String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  event          Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  overseer       EventAdmin?
  notes          EventNote[]
  posts          Post[]
  volunteers     Volunteer[]

  @@unique([eventId, departmentType])
  @@index([eventId])
}

model Event {
  id            String        @id @default(cuid())
  templateId    String
  joinCode      String        @unique @default(cuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  departments   Department[]
  template      EventTemplate @relation(fields: [templateId], references: [id])
  admins        EventAdmin[]
  notes         EventNote[]
  messages      Message[]
  roles         Role[]
  sessions      Session[]
  volunteers    Volunteer[]

  @@index([joinCode])
  @@index([templateId])
}

model EventAdmin {
  id           String      @id @default(cuid())
  adminId      String
  eventId      String
  role         EventRole
  departmentId String?     @unique
  claimedAt    DateTime    @default(now())
  admin        Admin       @relation(fields: [adminId], references: [id], onDelete: Cascade)
  department   Department? @relation(fields: [departmentId], references: [id])
  event        Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([adminId, eventId])
  @@index([adminId])
  @@index([eventId])
}

model EventNote {
  id           String      @id @default(cuid())
  content      String
  eventId      String
  departmentId String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  event        Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([departmentId])
  @@index([eventId])
}

model EventTemplate {
  id             String    @id @default(cuid())
  eventType      EventType
  circuit        String?
  region         String
  serviceYear    Int
  name           String
  theme          String?
  themeScripture String?
  venue          String
  address        String
  startDate      DateTime
  endDate        DateTime
  language       String    @default("en")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  events         Event[]

  @@unique([eventType, circuit, startDate])
  @@index([region])
  @@index([serviceYear])
}

model Message {
  id            String        @id @default(cuid())
  subject       String?
  body          String
  recipientType RecipientType
  recipientId   String
  isRead        Boolean       @default(false)
  readAt        DateTime?
  eventId       String
  senderId      String?
  volunteerId   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  event         Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sender        Admin?        @relation(fields: [senderId], references: [id])
  volunteer     Volunteer?    @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([recipientType, recipientId])
  @@index([volunteerId])
}

model Post {
  id           String               @id @default(cuid())
  name         String
  description  String?
  location     String?
  capacity     Int                  @default(1)
  departmentId String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  department   Department           @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  assignments  ScheduleAssignment[]

  @@index([departmentId])
}

model RefreshToken {
  id          String     @id @default(cuid())
  token       String     @unique
  expiresAt   DateTime
  revoked     Boolean    @default(false)
  adminId     String?
  volunteerId String?
  createdAt   DateTime   @default(now())
  admin       Admin?     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  volunteer   Volunteer? @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([expiresAt])
  @@index([token])
  @@index([volunteerId])
}

model Role {
  id          String      @id @default(cuid())
  name        String
  description String?
  sortOrder   Int         @default(0)
  eventId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  volunteers  Volunteer[]

  @@unique([eventId, name])
  @@index([eventId])
}

model ScheduleAssignment {
  id          String    @id @default(cuid())
  volunteerId String
  postId      String
  sessionId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  checkIn     CheckIn?
  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  volunteer   Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([volunteerId, sessionId])
  @@index([postId])
  @@index([sessionId])
  @@index([volunteerId])
}

model Session {
  id              String               @id @default(cuid())
  name            String
  date            DateTime             @db.Date
  startTime       DateTime             @db.Time(6)
  endTime         DateTime             @db.Time(6)
  eventId         String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  attendanceCount AttendanceCount?
  assignments     ScheduleAssignment[]
  event           Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([eventId])
}

model Volunteer {
  id                String               @id @default(cuid())
  volunteerId       String               @unique
  tokenHash         String
  firstName         String
  lastName          String
  email             String?
  phone             String?
  congregation      String
  appointmentStatus AppointmentStatus?   @default(PUBLISHER)
  notes             String?
  eventId           String
  departmentId      String?
  roleId            String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  messages          Message[]
  refreshTokens     RefreshToken[]
  assignments       ScheduleAssignment[]
  department        Department?          @relation(fields: [departmentId], references: [id])
  event             Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  role              Role?                @relation(fields: [roleId], references: [id])

  @@index([departmentId])
  @@index([eventId])
  @@index([volunteerId])
}

enum AppointmentStatus {
  PUBLISHER
  MINISTERIAL_SERVANT
  ELDER
}

enum CheckInStatus {
  CHECKED_IN
  CHECKED_OUT
  NO_SHOW
}

enum DepartmentType {
  ACCOUNTS
  ATTENDANT
  AUDIO_VIDEO
  BAPTISM
  CLEANING
  FIRST_AID
  INFORMATION_VOLUNTEER_SERVICE
  INSTALLATION
  LOST_FOUND_CHECKROOM
  PARKING
  ROOMING
  TRUCKING_EQUIPMENT
}

enum EventRole {
  EVENT_OVERSEER
  DEPARTMENT_OVERSEER
}

enum EventType {
  CIRCUIT_ASSEMBLY
  REGIONAL_CONVENTION
  SPECIAL_CONVENTION
}

enum RecipientType {
  INFORMATION_VOLUNTEER_SERVICE
  DEPARTMENT
  EVENT
}
