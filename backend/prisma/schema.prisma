generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Admin {
  id                   String        @id @default(cuid())
  email                String        @unique
  passwordHash         String        @map("password_hash")
  name                 String
  congregation         String
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  events               Event[]
  resolvedSwapRequests SwapRequest[]

  @@map("admins")
}

model Event {
  id          String      @id @default(cuid())
  name        String
  type        EventType
  location    String
  startDate   DateTime    @map("start_date")
  endDate     DateTime    @map("end_date")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  createdById String      @map("created_by_id")
  createdBy   Admin       @relation(fields: [createdById], references: [id])
  roles       Role[]
  sessions    Session[]
  volunteers  Volunteer[]
  zones       Zone[]

  @@map("events")
}

model Volunteer {
  id             String                  @id @default(cuid())
  name           String
  phone          String?
  email          String?
  congregation   String
  appointment    VolunteerAppointment    @default(PUBLISHER)
  generatedId    String                  @unique @map("generated_id")
  loginToken     String                  @map("login_token")
  createdAt      DateTime                @default(now()) @map("created_at")
  updatedAt      DateTime                @updatedAt @map("updated_at")
  eventId        String                  @map("event_id")
  roleId         String?
  assignments    Assignment[]
  suggestedSwaps SwapRequest[]           @relation("SuggestedSwap")
  availability   VolunteerAvailability[]
  event          Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  role           Role?                   @relation(fields: [roleId], references: [id])

  @@map("volunteers")
}

model VolunteerAvailability {
  id          String    @id @default(cuid())
  isAvailable Boolean   @default(true) @map("is_available")
  volunteerId String    @map("volunteer_id")
  sessionId   String    @map("session_id")
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  volunteer   Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([volunteerId, sessionId])
  @@map("volunteer_availability")
}

model Role {
  id           String      @id @default(cuid())
  name         String
  displayOrder Int         @default(0) @map("display_order")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  eventId      String      @map("event_id")
  event        Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  volunteers   Volunteer[]

  @@map("roles")
}

model Session {
  id           String                  @id @default(cuid())
  name         String
  date         DateTime
  startTime    DateTime                @map("start_time")
  endTime      DateTime                @map("end_time")
  createdAt    DateTime                @default(now()) @map("created_at")
  updatedAt    DateTime                @updatedAt @map("updated_at")
  eventId      String                  @map("event_id")
  assignments  Assignment[]
  event        Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  availability VolunteerAvailability[]

  @@map("sessions")
}

model Zone {
  id            String       @id @default(cuid())
  name          String
  description   String?
  requiredCount Int          @default(1) @map("required_count")
  displayOrder  Int          @default(0) @map("display_order")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  eventId       String       @map("event_id")
  assignments   Assignment[]
  event         Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("zone")
}

model Assignment {
  id           String        @id @default(cuid())
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  volunteerId  String        @map("volunteer_id")
  sessionId    String        @map("session_id")
  zoneId       String        @map("zone_id")
  session      Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  volunteer    Volunteer     @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  zone         Zone          @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  swapRequests SwapRequest[]
  checkIn      CheckIn?

  @@unique([volunteerId, sessionId])
  @@map("assignments")
}

model SwapRequest {
  id                   String            @id @default(cuid())
  reason               String
  status               SwapRequestStatus @default(PENDING)
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  resolvedAt           DateTime?         @map("resolved_at")
  assignmentId         String            @map("assignment_id")
  suggestedVolunteerId String?           @map("suggested_volunteer_id")
  resolvedById         String?           @map("resolved_by_id")
  assignment           Assignment        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  resolvedBy           Admin?            @relation(fields: [resolvedById], references: [id])
  suggestedVolunteer   Volunteer?        @relation("SuggestedSwap", fields: [suggestedVolunteerId], references: [id])

  @@map("swap_requests")
}

// Check-in records for assignment attendance tracking
model CheckIn {
  id           String        @id @default(cuid())
  checkInTime  DateTime      @map("check_in_time")
  checkOutTime DateTime?     @map("check_out_time")
  status       CheckInStatus @default(CHECKED_IN)
  isLate       Boolean       @default(false) @map("is_late")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String     @unique @map("assignment_id")

  @@map("check_ins")
}

enum CheckInStatus {
  CHECKED_IN
  CHECKED_OUT
  MISSED
}

enum SwapRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum EventType {
  CIRCUIT_ASSEMBLY
  REGIONAL_CONVENTION
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum VolunteerAppointment {
  PUBLISHER
  MINISTERIAL_SERVANT
  ELDER
}
